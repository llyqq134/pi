<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Отделы</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <header>
    <nav>
      <div>
        <a href="/dashboard.html">Главная</a>
        <a href="/workers.html">Сотрудники</a>
        <a href="/departments.html">Отделы</a>
        <a href="/equipment.html">Оборудование</a>
        <a href="/records.html">Выдача</a>
        <a href="/reports.html">Отчёты</a>
      </div>
      <div>
        <span class="user-info" id="userInfo"></span>
        <button class="logout-btn" onclick="logout()">Выход</button>
      </div>
    </nav>
  </header>
  <div class="container">
    <div class="card">
      <h2>Отделы</h2>
      <div id="message" class="message hidden"></div>
      <div id="addDeptForm" class="form-inline hidden">
        <input type="text" id="newDeptName" placeholder="Название отдела">
        <button class="btn btn-primary" onclick="addDepartmentSubmit()">Добавить отдел</button>
      </div>
      <table id="departmentsTable">
        <thead>
          <tr>
            <th>Название</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="departmentsBody">
        </tbody>
      </table>
    </div>
  </div>
  <script src="/static/js/api.js"></script>
  <script>
    requireAuth();
    const user = getCurrentUser();
    document.getElementById('userInfo').textContent = user?.name || '';
    const accessLevel = user?.accesslevel ?? 0;
    if (accessLevel >= 2) {
      document.getElementById('addDeptForm').classList.remove('hidden');
    }

    async function loadDepartments() {
      const msg = document.getElementById('message');
      msg.className = 'message hidden';
      try {
        const deps = await getDepartments();
        const tbody = document.getElementById('departmentsBody');
        const list = Array.isArray(deps) ? deps : [];
        tbody.innerHTML = list.map(d => {
          const name = d.name || d.Name || '';
          const delBtn = accessLevel >= 2 ? '<button class="btn btn-danger" onclick="deleteDeptClick(\'' + name.replace(/'/g, "\\'") + '\')">Удалить</button>' : '';
          return '<tr><td>' + name + '</td><td>' + delBtn + '</td></tr>';
        }).join('') || '<tr><td colspan="2">Нет отделов</td></tr>';
      } catch (e) {
        msg.textContent = e.message || 'Ошибка загрузки';
        msg.className = 'message error';
      }
    }

    async function addDepartmentSubmit() {
      const name = document.getElementById('newDeptName').value.trim();
      const msg = document.getElementById('message');
      msg.className = 'message hidden';
      if (!name) {
        msg.textContent = 'Введите название отдела';
        msg.className = 'message error';
        return;
      }
      try {
        await addDepartment(name);
        msg.textContent = 'Отдел создан';
        msg.className = 'message success';
        document.getElementById('newDeptName').value = '';
        loadDepartments();
      } catch (e) {
        msg.textContent = e.message || 'Ошибка';
        msg.className = 'message error';
      }
    }

    async function deleteDeptClick(name) {
      if (!confirm('Удалить отдел «' + name + '»?')) return;
      const msg = document.getElementById('message');
      msg.className = 'message hidden';
      try {
        await deleteDepartment(name);
        msg.textContent = 'Отдел удалён';
        msg.className = 'message success';
        loadDepartments();
      } catch (e) {
        msg.textContent = e.message || 'Ошибка';
        msg.className = 'message error';
      }
    }

    loadDepartments();
  </script>
</body>
</html>
